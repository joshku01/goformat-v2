kind: pipeline
type: docker
name: default

# disable default git clone
clone:
  disable: true

## å®šç¾©åŸºæœ¬è·¯å¾‘
workspace:
  base: /go/src
  path: ${DRONE_REPO_NAME}

steps:
  ## custom git clone default
  - name: clone
    image: plugins/drone-git:latest
    environment:
      RSYNC_KEY:
        from_secret: rsync_key
    commands:
      ## add git config
      - git config --global user.name "joshku01"
      - git config --global user.email "sd520255@gmail.com"
      - mkdir ~/.ssh
      - echo "$RSYNC_KEY" > ~/.ssh/id_rsa
      - chmod 600 ~/.ssh/id_rsa
      ## add to known hosts
      - ssh-keyscan -H github.com >> ~/.ssh/known_hosts
      ## git clone & git submodule
      - git clone ${DRONE_GIT_SSH_URL} .
      - git checkout $DRONE_COMMIT
      - git submodule update --recursive --init

  ## å‚™ä»½ vendor.json & è¨­å®š k8s image tag
  - name: backup-vendor-json
    image: nexus.cqgame.games/rd3/drone-git:latest
    commands:
      - echo "$(git rev-parse --short=7 ${DRONE_COMMIT_SHA})-dev" > ./tmp.txt
      - cat ./tmp.txt > .tags
      - echo ",latest-${DRONE_BRANCH}" >> .tags
      - mv vendor/vendor.json vendor.json
    when:
      ref: [refs/heads/develop, refs/heads/qatest, refs/heads/int]

  ## å‚™ä»½æ­£å¼ç«™ vendor.json & è¨­å®š k8s image tag
  - name: backup-prod-vendor-json
    image: nexus.cqgame.games/rd3/drone-git:latest
    commands:
      - echo ${DRONE_TAG}-prod  > ./tmp.txt
      - cat ./tmp.txt > .tags
      - echo ",latest-prod" >> .tags
      - mv vendor/vendor.json vendor.json
    when:
      ref: [refs/tags/v*,refs/tags/t*]

  ## vendor å¿«å– restore
  - name: restore-vendor-cache
    image: nexus.cqgame.games/rd3/drone-volume-cache:latest
    volumes:
      - name: cache
        path: /cache
    settings:
      restore: true
      mount:
        - ./vendor

  ## ç·¨è­¯ golang
  - name: build-golang-code
    image: nexus.cqgame.games/rd3/drone-govendor:latest
    commands:
      - mv vendor.json vendor/vendor.json
      - govendor sync
      - swag init

  ## vendor å¿«å– rebuild
  - name: rebuild-vendor-cache
    image: nexus.cqgame.games/rd3/drone-volume-cache:latest
    volumes:
      - name: cache
        path: /cache
    settings:
      rebuild: true
      mount:
        - ./vendor

  ## å»ºç½®å®¹å™¨ä¸¦å‚³è‡³ harbor (dev qa INT Project)
  - name: build-image
    image: nexus.cqgame.games/rd3/drone-docker:18.09.6
    settings:
      registry: nexus.cqgame.games
      template: >
      repo: nexus.cqgame.games/rd3/golang-${DRONE_REPO_NAME}
      dockerfile: ./k8s.Dockerfile
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
    volumes:
      - name: docker
        path: /var/run/docker.sock
    when:
      ref: [refs/heads/develop, refs/heads/qatest, refs/heads/int]

  ## å»ºç½®å®¹å™¨ä¸¦å‚³è‡³ harbor (T2 Project)
  - name: build-sync-images
    image: nexus.cqgame.games/rd3/drone-docker:18.09.6
    settings:
      registry: nexus.cqgame.games
      repo: nexus.cqgame.games/rd3-sync/golang-${DRONE_REPO_NAME}
      dockerfile: ./k8s.Dockerfile
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
    volumes:
      - name: docker
        path: /var/run/docker.sock
    when:
      ref: [refs/tags/v*,refs/tags/t*]

  ## é‡æ–°è¦†è“‹ .tag æª”æ¡ˆå…§å®¹
  - name: rebuild-tag-file
    image: nexus.cqgame.games/rd3/drone-git:latest
    commands:
      - cat ./tmp.txt > .tags
      - cat .tags

  ## ä½ˆç½²è‡³ dev k8s ç’°å¢ƒ
  - name: deploy-dev-k8s
    image: nexus.cqgame.games/rd3/drone-kubernetes:latest
    settings:
      kubernetes_server: https://k8s.ny.corp/k8s/clusters/local
      namespace: rd3-dev-${DRONE_REPO_NAME}
      deployment: dev-${DRONE_REPO_NAME}-deployment
      repo: nexus.cqgame.games/rd3/golang-${DRONE_REPO_NAME}
      container: dev-${DRONE_REPO_NAME}
      use_tags_file: true
      kubernetes_token:
        from_secret: kubernetes_token
    when:
      ref: [refs/heads/develop]

    ## ä½ˆç½²è‡³ grpc dev k8s ç’°å¢ƒ
  - name: deploy-dev-grpc-k8s
    image: nexus.cqgame.games/rd3/drone-kubernetes:latest
    settings:
      kubernetes_server: https://k8s.ny.corp/k8s/clusters/local
      namespace: rd3-dev-${DRONE_REPO_NAME}
      deployment: dev-${DRONE_REPO_NAME}-grpc-deployment
      repo: nexus.cqgame.games/rd3/golang-${DRONE_REPO_NAME}
      container: dev-${DRONE_REPO_NAME}-grpc
      use_tags_file: true
      kubernetes_token:
        from_secret: kubernetes_token
    when:
      ref: [refs/heads/develop]

  ## ä½ˆç½²è‡³ qa k8s ç’°å¢ƒ
  - name: deploy-qa-k8s
    image: nexus.cqgame.games/rd3/drone-kubernetes:latest
    settings:
      kubernetes_server: https://k8s.ny.corp/k8s/clusters/local
      namespace: rd3-qa-${DRONE_REPO_NAME}
      deployment: qa-${DRONE_REPO_NAME}-deployment
      repo: nexus.cqgame.games/rd3/golang-${DRONE_REPO_NAME}
      container: qa-${DRONE_REPO_NAME}
      use_tags_file: true
      kubernetes_token:
        from_secret: kubernetes_token
    when:
      ref: [refs/heads/qatest]

    ## ä½ˆç½²è‡³ grpc qa k8s ç’°å¢ƒ
  - name: deploy-qa-grpc-k8s
    image: nexus.cqgame.games/rd3/drone-kubernetes:latest
    settings:
      kubernetes_server: https://k8s.ny.corp/k8s/clusters/local
      namespace: rd3-qa-${DRONE_REPO_NAME}
      deployment: qa-${DRONE_REPO_NAME}-grpc-deployment
      repo: nexus.cqgame.games/rd3/golang-${DRONE_REPO_NAME}
      container: qa-${DRONE_REPO_NAME}-grpc
      use_tags_file: true
      kubernetes_token:
        from_secret: kubernetes_token
    when:
      ref: [refs/heads/qatest]

  ## ä½ˆç½²è‡³ int k8s ç’°å¢ƒ
  - name: deploy-int-k8s
    image: nexus.cqgame.games/rd3/drone-kubernetes:latest
    settings:
      kubernetes_server: https://k8s.ny.corp/k8s/clusters/local
      namespace: rd3-int-${DRONE_REPO_NAME}
      deployment: int-${DRONE_REPO_NAME}-deployment
      repo: nexus.cqgame.games/rd3/golang-${DRONE_REPO_NAME}
      container: int-${DRONE_REPO_NAME}
      use_tags_file: true
      kubernetes_token:
        from_secret: kubernetes_token
    when:
      ref: [refs/heads/int]

    ## ä½ˆç½²è‡³ grpc int k8s ç’°å¢ƒ
  - name: deploy-int-grpc-k8s
    image: nexus.cqgame.games/rd3/drone-kubernetes:latest
    settings:
      kubernetes_server: https://k8s.ny.corp/k8s/clusters/local
      namespace: rd3-int-${DRONE_REPO_NAME}
      deployment: int-${DRONE_REPO_NAME}-grpc-deployment
      repo: nexus.cqgame.games/rd3/golang-${DRONE_REPO_NAME}
      container: int-${DRONE_REPO_NAME}-grpc
      use_tags_file: true
      kubernetes_token:
        from_secret: kubernetes_token
    when:
      ref: [refs/heads/int]

  ## æ¨é€è‡³æ­£å¼ç«™ gitlab
  - name: push-release
    image: nexus.cqgame.games/rd3/drone-git:latest
    environment:
      RSYNC_KEY:
        from_secret: rsync_key
    commands:
      - git config --global user.name "drone"
      - git config --global user.email "drone@cchntek.com"
      - mkdir ~/.ssh
      - echo "$RSYNC_KEY" > ~/.ssh/id_rsa
      - chmod 600 ~/.ssh/id_rsa
      - ssh-keyscan -H gitlab.cqgame.info >> ~/.ssh/known_hosts
      - cd /tmp
      - git clone git@gitlab.cqgame.info:RD3/${DRONE_REPO_NAME}.git
      - cp -rf /go/src/${DRONE_REPO_NAME}/* ./${DRONE_REPO_NAME}/
      - cp /go/src/${DRONE_REPO_NAME}/.drone.yml ./${DRONE_REPO_NAME}/
      - cd ${DRONE_REPO_NAME}
      - sed -e 's/nexus.cqgame.games\\/rd3/nexus.cqgame.cc\\/rd3-sync/' -i .drone.yml
      - git add --all
      - git commit -m "Build - ${DRONE_TAG}"
      - git tag -a release-${DRONE_TAG} -m "Build - ${DRONE_TAG}" -f
      - git push origin release-${DRONE_TAG} -f
    when:
      ref: [refs/tags/v*, refs/tags/t*]

  ## ä½ˆç½²è‡³ pro k8s ç’°å¢ƒ
  - name: deploy-pro-k8s
    image: nexus.cqgame.games/rd3/drone-kubernetes:latest
    settings:
      kubernetes_server: https://k8s.ny.corp/k8s/clusters/local
      namespace: rd3-pro-${DRONE_REPO_NAME}
      deployment: pro-${DRONE_REPO_NAME}-deployment
      repo: nexus.cqgame.games/rd3/golang-${DRONE_REPO_NAME}
      container: pro-${DRONE_REPO_NAME}
      use_tags_file: true
      kubernetes_token:
        from_secret: kubernetes_token
    when:
      ref: [refs/tags/release-v*]

    ## ä½ˆç½²è‡³ grpc pro k8s ç’°å¢ƒ
  - name: deploy-pro-grpc-k8s
    image: nexus.cqgame.games/rd3/drone-kubernetes:latest
    settings:
      kubernetes_server: https://k8s.ny.corp/k8s/clusters/local
      namespace: rd3-pro-${DRONE_REPO_NAME}
      deployment: pro-${DRONE_REPO_NAME}-grpc-deployment
      repo: nexus.cqgame.games/rd3/golang-${DRONE_REPO_NAME}
      container: pro-${DRONE_REPO_NAME}-grpc
      use_tags_file: true
      kubernetes_token:
        from_secret: kubernetes_token
    when:
      ref: [refs/tags/release-v*]

  ## Telegram æ¨æ’­é€šçŸ¥
  - name: telegram
    image: nexus.cqgame.games/rd3/drone-telegram:1.3.5
    settings:
      token:
        from_secret: telegram_token
      to:
        from_secret: telegram_to
      format: markdown
      message:  >
        {{#success build.status}}
        âœ… Build #{{build.number}} of `{{repo.name}}` succeeded.

        ğŸ“ Commit by `{{commit.author}}` on `{{commit.branch}}`:

        ```
        {{commit.message}}
        ```

        ğŸŒ {{ build.link }}
        {{else}}
        âŒ Build #{{build.number}} of `{{repo.name}}` failed.

        ğŸ“  Commit by `{{commit.author}}` on `{{commit.branch}}`:

        ```
        {{commit.message}}
        ```
        ğŸŒ {{ build.link }}
        {{/success}}


        ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸
    when:
      status: [ success, failure ]

## VM æ›è¼‰è·¯å¾‘
volumes:
  - name: cache
    host:
      path: /usr/local/app/cache
  - name: docker
    host:
      path: /var/run/docker.sock

## è¼‰å…¥ docker config è¨­å®š
image_pull_secrets:
  - dockerconfigjson

# è§¸ç™¼ pipeline æ¢ä»¶
trigger:
  ref:
    include: [refs/heads/develop, refs/heads/qatest, refs/heads/int, refs/tags/v*, refs/tags/t*, refs/tags/release-v*]
